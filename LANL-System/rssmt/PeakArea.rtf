{\rtf1\ansi\ansicpg1252\deff0\deflang1033{\fonttbl{\f0\fnil\fcharset0 Calibri;}}
{\*\generator Msftedit 5.41.21.2510;}\viewkind4\uc1\pard\sa200\sl276\slmult1\lang9\f0\fs22 Peak area calculation\par
Gauss fit returns peak area. Study S/N for this. Actually good!\par
Gauss fit does pedestal slope correction. Resulting spectrum (If Q curve corrected) just needs to be summed and normalized  from 30 to 70% to calculate area. First vi selects subset of array, then second vi does numeric integration. Easy to add. Change gauss fit vi to accomplish. Changed fitdata.vi to do so.\par
DAC precompute working after initialization loop fix! Output loop changed to simple strcat, same speed but much simpler.  Merging I2C or sdev info into output loop slows down I/O (makes duty factor worse?). Put fixed number of read delays at beginning of sweep to fix 1st freq point (10). May be fixed now by simply dropping first reads, was averaging. Good for short cable. Number of NB internal sweeps raised from 10  to 20. Sweep rate ~75 Hz for 100 freq steps and single sample, ~7500 Hz effective throughput! No need to go faster than this, as BW is ~5 kHz. Speed up effort successful. Continue to clean up code. 500 steps is now ~30 Hz for singles (~15 kHz), excellent! Leave FPGA code alone, works well.\par
Next - test 2nd NMR board with replaced mixer, verify equivalent performance. Ask Jackie for fix on Tuesday.\par
Started using long (2m) cable again to study noise and optimize number of samples. 1st point always low, not fixed by delay of freq range, better for more freq points.  Good S/N, ~70, optimum for fewest freq points and samples.  Best phase ~0.5V after fix below, lower than for short cable. Wondering if 5V ADC range would be better than 10 in some cases? Can clearly see steps from digitizer with single sample. Don't know if noise is significant there. Noise better with slightly short cable to inductor, tune voltage ~1V. Really need a careful optimization of S/N with real TE signal (May?).\par
Estimate how much to reduce delay line length. Believe we want to reduce at least by amount of 2nd delay line, but perhaps 2X. Check log tune voltage. Want to reach that phase voltage @ < 11V. Make sure the direction makes sense! As voltage rises, phase is delayed. Yet, adding delay line, results in higher tuning voltages. Contradictory? No. Minimum delay length determined, short loop only plus connecting cable. Understand phase shifter now, moves phase backward with increasing voltage! Quite non-linear (faster shift) near 180 degrees phase shift (~9V).\par
How to measure dispersion? Imaginary term leads to real part (absorption, emssion). Imaginary part is phase shift. Set tune to max log response, than vary phase until zero offset. See what signal remains, if any? Dispersion should peak and then reverse sign at center frequency.\par
Still worried if my tuning procedure (optimize S/N for crystal) is correct for actual NMR signal. Options: 1: Use log tune to set phase, poor S/N. 2: Set phase and tune for maximum signal. 3: Set phase and tune for best S/N. 4: Set phase and tune for largest offset, probably close to #1. Maybe that tuning for max signal makes most sense?\par
OK, looks like phase shift is due to inductively coupled crystal. Phase lag likely results from secondary winding length and loose coupling (leakage inductance). Will try a DC (resistor) coupled crystal. Hope to reduce large (50 deg) shift to something close to nominal tune.  Need to see that Liverpool tune method works for our NMR system. Easiest to modify existing 2nd crystal in SMA box. Disconnect secondary winding and add resistor. Leave winding physically in place. Resistor value about 1K for starters. If no peak seen, reduce R. Should order more crystals, so we can pick nice peak shapes (using a socket). No idea what crystal resistance is for overtones. 3rd overtone are usually >= 3X higher impedance. So expect high impedance. (At least 13 * 30 = 400 ohms). Get 10 crystals and socketed assy. to pick a nicer peak shape / complex.\par
With 1K series resistor, phase shift and phase dependence reduced dramatically! S/N increase with reducing phase voltage mostly due to reduction of background. Amplitude fairly flat with phase, perhaps due to dispersion in crystal? Could resonate away the xtal cap (~7pf) but will likely cause other issues? 150R too low, leading to large phase shift, probably due to crystal capacitance and loading of coil. \par
Log filtering has too long time constant, due to AD8307 50K output resistor plus 0.1uF cap. About 150X longer time than IF chain! Reduce to .001uF and test on existing board. Currently, peak position is quite dependent on log scan time, making IF tuning a chore. Weak peaks marginal on log chain, but Q curve tuning is OK once time dependence is fixed. 0.001\par
Believe we have LO delay cable about correct length. Nominal phase is ~6.4V. \par
Working on AK's Intel Nuc box. LANL security software horrible, always rebooting, programs blocked. Adobe acrobat and reader both broken. LV installed, NB installed, ISE being installed. Older NB eclipse would not work with this windows 7. If this all works, device should be acceptable. Operating system will require reinstall without crapware. Amazing anything gets done on LANL window machines! ISE installed using free webpack license (not node locked). Ready to test, works fine. Will eventually fail enterprise validation. Still reboots about weekly. NUC is good CPU, once drivers are loaded.\par
Wrote DAC code for fast FPGA implementation of SPI. Will also need NB code to test. Not difficult, just write header and 2 increment registers. Then start using control register for reset or increment. Registers can be read back. NB test code written.\par
NUC setup from scratch: Window7 pro x,  ethernet driver x,  usb3 driver x,  graphics driver x, wireless driver x, labview x, netburner x, ise13.4 x, acrobat reader x, java 32 x, express C++ x,  excel or equiv. office suite x,  fpga code, nb code, labview code, labview internet toolkit x, telnet, FTDI driver x, iso mounter x, 7zip x, digilent tools x, root x, firefox x, expresspcb x, topspice x, cutepdf x, eagle x, avg? NUC's work well. Good wireless and USB3. Will have two identical units (via cloning). Cloning failed due to different ssd sizes (250 versus 500 GB). Win 7 backups useless for system files. 2 working systems available. Fully licensed LV, Win7, NB. Machines seem to work perfectly. Important Win 7 updates all installed. AVG becoming annoying.\par
New NMR delay line implemented, single loop, disconnectable. Out for quote. Plan to order 10 more boards. Still need to repair NMR card with bad mixer, do coax cable mod and log filter cap change. Stability is very good. Had occasional noise, minimized by tying and cushioning RF cables.  Seems to be low frequency mechanical noise in nature. Was also cured by taking fewer frequency steps. So faster is still better. Keep pushing on this, remembering our existing shaping times limit us to ~ 15kHz. For 200 points, current rate is ~40Hz*200 = 8kHz. Can go about twice as fast without major change. \par
Final 10 NMR boards out for production, <10k$. Last prototype with short coax cable working. Delay may be a little short, should be better on production board (lower velocity). Small series inductor or wire could be used to tweak delay? Cannot peak crystal S/N, but not really needed. Signal amplitude and tune voltage are correct.\par
Switching out components for Andi to take to UVa. Controller, NMR board, computer, cable / adapter for FM sweep.\par
New NUC not working correctly with Labview? Something wrong with VISA / MAX. Tried re-install of LV 2013, same problem. Finds GPIB but can't communicate. Go back to 2012 version and try again. Should order a 500 GB SSD m.2 drive to allow for direct cloning. Cannot comminicate or test GPIB-ENET1000. Got VISA driver error in MAX that can't be cleared. Horrible software! Wonder if I ever used 2013 disks before? Computers should be pretty much identical, software wise. Yes, 2013 installed fine on MBAirs. What is going on? Some kind of software conflict? NI/MAX OK until GPIB-ENET is tested. Then complains about driver busy and never works again. Wonder if I can do a repair? Or is something install order dependent. Write down exact error message and search on web. Wish I knew what LV version I installed, but expect it is 2013. Internet toolikit was 2012 (most recent). Could try USB-GPIB interface or LV application. Maybe it's just MAX? Just order another m.2 drive.\par
Got DHCP server working with ActionTec modem and Netgear switch for testing new DAC code. Code not working yet.Added infinite step loop to help with scope debugging. DAC4 shows no output. Found that I was using wrong clock edge! DAC latches each bit on falling clock edge. Fixed, so try again. Added scope start (positive edge) to each data transfer. Clock runs all of time now. Can undo later. Fixed. One extra clock at beginning before sync is active. Fixed by gating clock on dac_sync (only). Exactly 24 clocks now.\par
Steps: verify clock, LDAC, SDIN, CLR. Check SDO if helpful. Add scope loop on -1V setting or increment. Input signals verfied and data correct. Now working with one extra clock pulse before sync is active (OK). Clock now gated by state machine. Had problem with clock always loop not working correctly. Still not fully understood, but always @ (*) works fine. Settling time is significant (~3 usec). Increment speed is very fast, again few usec. Correct sequence is trigger ADC, increment DAC, read ADC (slow, providing settling time) and repeat.\par
Same approach can work for ADC readout. With enough registers, combining SPI mode with multiplexer is no real problem. For ADC, need 8 bit command register plus 16 bit readback.\par
Implementation in Dual DAQ board system: 2 different DAQ card addresses.\tab\tab\tab\tab 1. Set DAQ address, preset to -1V, write step value (provides delay)\tab\tab\tab\tab 2. Set ADC address, trigger ADC conv\tab\tab\tab\tab\tab\tab\tab\tab 3. Set DAQ address, step voltage\tab\tab\tab\tab\tab\tab\tab\tab 4. Set ADC address, readout ADC, trigger ADC conv (provides delay)\tab\tab\tab\tab 5. Repeat @ #3\par
New GPIB-USB interface installed and working in NMR system. Returned borrowed unit. Wonder if Silex ETH_USB device works with this interface?\par
Next jobs - get front panels produced. Provide sufficient clearance on holes. Start with NMR analog board?\par
Simple peak area almost there. Calculate offset and slope and remove as done at input to gauss fit. Then simply add up 30-70% interval. Working. S/N similar to gauss fit. \par
Polarized target at UVa is working. NMR working. Need to study S/N for TE signal. Some mods to LV software needed. Phase V not in data file header. Polarity of autotune wrong when not inverted. Polarity of background subtract likewise wrong. Name of average and raw data files different. Should write out peak area somewhere, either data header or? S/N appears very good (>10), even for 400 steps. TE about 60 mV, shows that phase adjustment is better than in Dec? >~70% polariz. obtained. Q curve subtract works pretty well. No crippling noise. TE visible on each 1 sec sweep. Expect peak area subtract will have 2X worse S/N, still OK.\par
If we get S/N = 5 per sec, how many secs for 0.5% accuracy? .005/.2 = 1/2 hr. Would be great. Noise is repetitive, ~2X scan freq @ 400 pts/sweep, 50-60Hz. Could be fit with gauss + sine and removed? Faster scan would likely be worse. Peak area after removing just baseline gives S/N = 7! Fit should do even better. Use labview non-linear fit example. FIt components gauss (with fixed width and center) plus sine wave (with ~fixed period) and linear poly. Want fit to return amplitude and phase of background, plus poly coeff. Then remove sine wave and poly from spectrum to compute area. Noise is not sine wave. Removal does not work well. Noise has some triangular component.\par
 Gauss TE peak width 65.5 kHz, centroid 213.04, area .00322, area S/N 6.6, peak S/N 12. Does pretty well. Real peak is sharper at top and wider on tails. Not sure how to proceed. Could reject sweeps that have a poor gaussian fit or large residual under peak. \par
\par
}
 